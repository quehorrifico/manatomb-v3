{{ define "cards_search" }}
  {{ template "layout_header" . }}
  {{ $ctx := .Data }}

  <main class="max-w-4xl mx-auto py-10 px-4 space-y-6">
    <!-- Page header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h2 class="text-2xl font-semibold tracking-tight">
          <span class="bg-gradient-to-br from-sky-400 via-cyan-300 to-slate-100 bg-clip-text text-transparent">
            Card Search
          </span>
        </h2>
        <p class="text-sm text-slate-400 mt-1">
          Search the Scryfall database and add cards directly to your decks.
        </p>
      </div>

      {{ if .CurrentUser }}
        <div class="flex flex-wrap gap-2">
          <a href="/decks"
             class="inline-flex items-center px-3 py-1.5 rounded-md border border-slate-700 bg-slate-900 text-xs text-slate-200 hover:border-sky-400 hover:text-sky-300 transition-colors">
            My decks
          </a>
        </div>
      {{ end }}
    </div>

    <!-- Search + filters -->
    <section class="rounded-xl border border-slate-800 bg-slate-950/80 p-4 space-y-4 shadow-md shadow-sky-500/10">
      <form method="GET" action="/cards/search" class="space-y-4">
        <div class="flex flex-col md:flex-row gap-3">
          <label class="flex-1 text-sm text-slate-200">
            <span class="block text-xs font-medium text-slate-400 mb-1">Name</span>
            <input type="text"
                   name="q"
                   value="{{ $ctx.Query }}"
                   placeholder="Search by name (e.g. Sol Ring, Lightning Bolt)"
                   class="w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400">
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <fieldset class="text-sm text-slate-200">
            <legend class="block text-xs font-medium text-slate-400 mb-1">
              Colors (color identity)
            </legend>
            <div class="flex flex-wrap gap-3">
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" name="color" value="W"
                       class="rounded border-slate-600 bg-slate-950 text-sky-500 focus:ring-sky-500">
                <span>W</span>
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" name="color" value="U"
                       class="rounded border-slate-600 bg-slate-950 text-sky-500 focus:ring-sky-500">
                <span>U</span>
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" name="color" value="B"
                       class="rounded border-slate-600 bg-slate-950 text-sky-500 focus:ring-sky-500">
                <span>B</span>
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" name="color" value="R"
                       class="rounded border-slate-600 bg-slate-950 text-sky-500 focus:ring-sky-500">
                <span>R</span>
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" name="color" value="G"
                       class="rounded border-slate-600 bg-slate-950 text-sky-500 focus:ring-sky-500">
                <span>G</span>
              </label>
            </div>
            <p class="mt-1 text-xs text-slate-500">
              Leave empty for any colors.
            </p>
          </fieldset>

          <div class="text-sm text-slate-200">
            <label class="block text-xs font-medium text-slate-400 mb-1">
              Type
            </label>
            <select name="type"
                    class="w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400">
              <option value="">Any type</option>
              <option value="creature">Creature</option>
              <option value="instant">Instant</option>
              <option value="sorcery">Sorcery</option>
              <option value="artifact">Artifact</option>
              <option value="enchantment">Enchantment</option>
              <option value="planeswalker">Planeswalker</option>
              <option value="land">Land</option>
            </select>
            <p class="mt-1 text-xs text-slate-500">
              Simple Scryfall type filter (e.g. creature, instant, land).
            </p>
          </div>
        </div>

        <div class="flex justify-end">
          <button type="submit"
                  class="inline-flex items-center px-4 py-2 rounded-md bg-sky-500 text-slate-950 text-sm font-semibold hover:bg-sky-400 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 focus:ring-offset-slate-950">
            Search
          </button>
        </div>
      </form>
    </section>

    <!-- Results -->
    <section class="space-y-3">
      {{ if $ctx.HasSearched }}
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-slate-100">
            Results
            {{ if $ctx.Results }}
              <span class="ml-1 text-xs text-slate-500">
                ({{ len $ctx.Results }})
              </span>
            {{ end }}
          </h3>
          <p class="text-xs text-slate-500">
            Click a card to see details.
          </p>
        </div>

        {{ if $ctx.Results }}
        <ul class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {{ range $ctx.Results }}
            <li class="rounded-xl border border-slate-800 bg-slate-950/80 p-2 shadow-md shadow-sky-500/10">
              <button
                type="button"
                class="w-full flex items-center justify-center"
                data-card-detail
                data-name="{{ .Name }}"
                data-mana-cost="{{ .ManaCost }}"
                data-type-line="{{ .TypeLine }}"
                data-image-uri="{{ .ImageURI }}"
                data-price="{{ .PriceUSD }}"
                data-artist="{{ .Artist }}">
                {{ if .ImageURI }}
                  <img src="{{ .ImageURI }}"
                       alt="{{ .Name }}"
                       class="w-full h-auto rounded-md border border-slate-800 shadow-md shadow-slate-900/80">
                {{ else }}
                  <div class="w-full aspect-[3/4] flex items-center justify-center text-xs text-slate-400">
                    No image
                  </div>
                {{ end }}
              </button>
              <div class="hidden js-oracle-text">
                {{ .OracleText }}
              </div>
            </li>
          {{ end }}
        </ul>
        {{ else }}
          <p class="text-sm text-slate-400">
            No results. Try adjusting your name, colors, or type filters.
          </p>
        {{ end }}
      {{ else }}
        <p class="text-sm text-slate-400">
          Enter a name or choose filters above to begin searching.
        </p>
      {{ end }}
    </section>
  </main>

  <!-- Card detail modal -->
  <div id="card-detail-modal"
       class="fixed inset-0 bg-slate-950/80 flex items-center justify-center z-50 hidden">
    <div class="max-w-xl w-full mx-4 rounded-xl border border-slate-800 bg-slate-950 p-4 shadow-lg shadow-sky-500/20 relative">
      <button type="button"
              class="absolute top-2 right-2 text-slate-400 hover:text-slate-200 text-xs"
              data-close-modal>
        Close
      </button>

      <div class="grid gap-4 md:grid-cols-[minmax(0,1.1fr)_minmax(0,1.4fr)] items-start">
        <div class="flex items-center justify-center">
          <img data-field="image"
               alt=""
               class="w-full max-w-xs h-auto rounded-md border border-slate-800 shadow-md shadow-slate-900/80">
        </div>

        <div class="space-y-3 text-sm text-slate-200">
          <h3 class="text-lg font-semibold text-slate-50" data-field="name"></h3>
          <p class="text-xs uppercase tracking-wide text-slate-400">
            <span data-field="type-line"></span>
          </p>

          <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-slate-300">
            <span>
              <span class="font-medium text-slate-200">Cost:</span>
              <span data-field="mana-cost" class="inline-flex items-center gap-1 align-middle"></span>
            </span>
            <span>
              <span class="font-medium text-slate-200">Price:</span>
              <span data-field="price-usd">—</span>
            </span>
            <span>
              <span class="font-medium text-slate-200">Artist:</span>
              <span data-field="artist">—</span>
            </span>
          </div>

          <p class="text-xs text-slate-500">
            Prices via Scryfall (USD, approximate).
          </p>

          <p class="text-sm text-slate-200 whitespace-pre-line" data-field="oracle-text"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    var modal = document.getElementById('card-detail-modal');
    if (!modal) return;

    var nameEl = modal.querySelector('[data-field="name"]');
    var typeEl = modal.querySelector('[data-field="type-line"]');
    var manaEl = modal.querySelector('[data-field="mana-cost"]');
    var oracleEl = modal.querySelector('[data-field="oracle-text"]');
    var imageEl = modal.querySelector('[data-field="image"]');
    var priceEl = modal.querySelector('[data-field="price-usd"]');
    var artistEl = modal.querySelector('[data-field="artist"]');

    function closeModal() {
      modal.classList.add('hidden');
    }

    function renderManaSymbols(manaCost) {
      if (!manaCost) return '';
      var html = '';
      var re = /\{([^}]+)\}/g;
      var match;
      while ((match = re.exec(manaCost)) !== null) {
        var sym = match[1];
        var encoded = encodeURIComponent(sym);
        var src = 'https://svgs.scryfall.io/card-symbols/' + encoded + '.svg';
        html += '<img src="' + src + '" alt="{' + sym + '}" class="inline-block h-5 align-text-bottom mr-0.5">';
      }
      return html;
    }

    modal.querySelectorAll('[data-close-modal]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        closeModal();
      });
    });

    modal.addEventListener('click', function (e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    document.querySelectorAll('[data-card-detail]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var li = btn.closest('li');
        if (!li) return;

        var oracleNode = li.querySelector('.js-oracle-text');
        var oracleText = oracleNode ? oracleNode.textContent : '';

        var name = btn.getAttribute('data-name') || '';
        var manaCost = btn.getAttribute('data-mana-cost') || '';
        var typeLine = btn.getAttribute('data-type-line') || '';
        var imageUri = btn.getAttribute('data-image-uri') || '';
        var price = btn.getAttribute('data-price') || '';
        var artist = btn.getAttribute('data-artist') || '';

        // Set values from server-provided data
        if (nameEl) nameEl.textContent = name;
        if (typeEl) typeEl.textContent = typeLine;
        if (manaEl) manaEl.innerHTML = renderManaSymbols(manaCost);
        if (oracleEl) oracleEl.textContent = oracleText;

        if (priceEl) {
          priceEl.textContent = price ? ('$' + price) : '—';
        }

        if (artistEl) {
          artistEl.textContent = artist || '—';
        }

        if (imageEl) {
          if (imageUri) {
            imageEl.src = imageUri;
            imageEl.classList.remove('hidden');
          } else {
            imageEl.src = '';
            imageEl.classList.add('hidden');
          }
        }

        modal.classList.remove('hidden');
      });
    });
  });
  </script>

  {{ template "layout_footer" . }}
{{ end }}